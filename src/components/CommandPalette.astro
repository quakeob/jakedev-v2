<!-- Command Palette ‚Äî ‚åòK / Ctrl+K -->
<div id="cmd-palette-overlay" class="cmd-overlay" aria-hidden="true">
  <div class="cmd-modal">
    <div class="cmd-input-wrap">
      <svg class="cmd-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="cmd-input" class="cmd-input" type="text" placeholder="Type a command‚Ä¶" autocomplete="off" spellcheck="false" />
      <kbd class="cmd-kbd">ESC</kbd>
    </div>
    <div class="cmd-divider"></div>
    <div id="cmd-list" class="cmd-list" role="listbox"></div>
    <div id="cmd-generate" class="cmd-generate-wrap">
      <div class="cmd-gen-label">‚ú® Describe your dream theme</div>
      <div class="cmd-gen-row">
        <input id="cmd-gen-input" class="cmd-gen-input" type="text" placeholder="ocean sunset, cyberpunk city, forest at dawn‚Ä¶" autocomplete="off" spellcheck="false" />
        <button id="cmd-gen-go" class="cmd-gen-btn">Generate</button>
        <button id="cmd-gen-reset" class="cmd-gen-reset">Reset</button>
      </div>
      <div id="cmd-gen-pills" class="cmd-gen-pills"></div>
      <div id="cmd-gen-status" class="cmd-gen-status"></div>
    </div>
    <div class="cmd-footer">
      <span><kbd>‚Üë‚Üì</kbd> navigate</span>
      <span><kbd>‚Üµ</kbd> select</span>
      <span><kbd>esc</kbd> close</span>
    </div>
  </div>
</div>

<style>
  .cmd-overlay {
    position: fixed; inset: 0; z-index: 9999;
    display: flex; align-items: flex-start; justify-content: center;
    padding-top: min(20vh, 160px);
    background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    opacity: 0; visibility: hidden;
    transition: opacity .15s ease, visibility .15s ease;
  }
  .cmd-overlay.open { opacity: 1; visibility: visible; }
  .cmd-modal {
    width: 560px; max-width: calc(100vw - 32px);
    border-radius: 14px; overflow: hidden;
    background: var(--surface, #1e1e2e);
    border: 1px solid var(--border, #333);
    box-shadow: 0 16px 70px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.05) inset;
    transform: scale(0.96) translateY(-8px);
    transition: transform .15s ease;
  }
  .cmd-overlay.open .cmd-modal { transform: scale(1) translateY(0); }
  .cmd-input-wrap {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 16px;
  }
  .cmd-search-icon { color: var(--text-2, #888); flex-shrink: 0; }
  .cmd-input {
    flex: 1; background: none; border: none; outline: none;
    font: 15px/1 'Inter', system-ui, sans-serif;
    color: var(--text, #e0e0e0);
  }
  .cmd-input::placeholder { color: var(--text-2, #666); }
  .cmd-kbd {
    font: 11px/1 'JetBrains Mono', monospace;
    padding: 3px 6px; border-radius: 5px;
    background: var(--bg, #111); border: 1px solid var(--border, #333);
    color: var(--text-2, #888);
  }
  .cmd-divider { height: 1px; background: var(--border, #333); }
  .cmd-list {
    max-height: 340px; overflow-y: auto; padding: 6px;
    scrollbar-width: thin; scrollbar-color: var(--border, #333) transparent;
  }
  .cmd-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 8px; cursor: pointer;
    font: 14px/1.2 'Inter', system-ui, sans-serif;
    color: var(--text, #e0e0e0);
    transition: background .08s ease;
  }
  .cmd-item.active { background: var(--accent-bg, rgba(99,102,241,0.15)); color: var(--accent, #818cf8); }
  .cmd-item-icon { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; }
  .cmd-item-label { flex: 1; }
  .cmd-item-hint {
    font: 12px/1 'JetBrains Mono', monospace;
    color: var(--text-2, #666);
  }
  .cmd-footer {
    display: flex; gap: 16px; padding: 10px 16px;
    border-top: 1px solid var(--border, #333);
    font: 11px/1 'Inter', system-ui, sans-serif;
    color: var(--text-2, #666);
  }
  /* Generate theme mode */
  .cmd-generate-wrap {
    padding: 12px 16px;
    display: none;
  }
  .cmd-generate-wrap.active { display: block; }
  .cmd-gen-label {
    font: 12px/1 'Inter', system-ui, sans-serif;
    color: var(--text-2, #888);
    margin-bottom: 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .cmd-gen-row {
    display: flex; gap: 8px;
  }
  .cmd-gen-input {
    flex: 1; background: var(--bg, #111); border: 1px solid var(--border, #333);
    border-radius: 8px; padding: 10px 12px; outline: none;
    font: 14px/1 'Inter', system-ui, sans-serif;
    color: var(--text, #e0e0e0);
  }
  .cmd-gen-input::placeholder { color: var(--text-2, #666); }
  .cmd-gen-input:focus { border-color: var(--accent, #818cf8); }
  .cmd-gen-btn {
    padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer;
    font: 13px/1 'Inter', system-ui, sans-serif; font-weight: 600;
    background: var(--accent, #6366f1); color: #fff;
    transition: opacity .15s;
  }
  .cmd-gen-btn:hover { opacity: 0.85; }
  .cmd-gen-reset {
    padding: 10px 12px; border: 1px solid var(--border, #333); border-radius: 8px;
    background: none; cursor: pointer; color: var(--text-2, #888);
    font: 13px/1 'Inter', system-ui, sans-serif;
    transition: border-color .15s;
  }
  .cmd-gen-reset:hover { border-color: var(--text-2, #888); }
  .cmd-gen-pills {
    display: flex; flex-wrap: wrap; gap: 5px;
    margin-top: 10px; min-height: 0;
  }
  .cmd-gen-pill {
    font: 11px/1 'JetBrains Mono', monospace;
    padding: 4px 8px; border-radius: 99px;
    background: var(--accent-bg, rgba(99,102,241,0.15));
    color: var(--accent, #818cf8);
    animation: pill-in .2s ease;
  }
  @keyframes pill-in { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
  .cmd-gen-status {
    font: 12px/1.4 'Inter', system-ui, sans-serif;
    color: var(--text-2, #888);
    margin-top: 8px;
  }
  @keyframes shimmer-flash {
    0% { opacity: 1; }
    100% { opacity: 0; }
  }
  .theme-shimmer {
    position: fixed; inset: 0; z-index: 99999;
    background: var(--accent, #6366f1);
    opacity: 0; pointer-events: none;
    animation: shimmer-flash .4s ease-out forwards;
  }
  .cmd-footer kbd {
    font-family: 'JetBrains Mono', monospace;
    padding: 1px 4px; border-radius: 3px;
    background: var(--bg, #111); border: 1px solid var(--border, #333);
    font-size: 10px;
  }
</style>

<script is:inline>
(function() {
  const commands = [
    { icon: '‚ú®', label: 'Generate Theme‚Ä¶', action: 'generate', type: 'generate' },
    { icon: 'üè†', label: 'Home', action: '/', type: 'nav' },
    { icon: 'üíº', label: 'Work', action: '/#work', type: 'nav' },
    { icon: 'üë§', label: 'About', action: '/#about', type: 'nav' },
    { icon: 'üì∑', label: 'Photos', action: '/photos', type: 'nav' },
    { icon: 'üìù', label: 'Writing', action: '/writing', type: 'nav' },
    { icon: 'üìß', label: 'Contact', action: '/#contact', type: 'nav' },
    { icon: 'üîó', label: 'GitHub', action: 'https://github.com/quakeob', type: 'ext', hint: 'github.com' },
    { icon: 'üîó', label: 'X / Twitter', action: 'https://x.com/Jak3dev', type: 'ext', hint: 'x.com' },
    { icon: 'üé®', label: 'Theme: Default', action: 'default', type: 'theme' },
    { icon: 'üé®', label: 'Theme: Minimal', action: 'minimal', type: 'theme' },
    { icon: 'üé®', label: 'Theme: Terminal', action: 'terminal', type: 'theme' },
    { icon: 'üé®', label: 'Theme: Glass', action: 'glass', type: 'theme' },
    { icon: 'üé®', label: 'Theme: Brutalist', action: 'brutalist', type: 'theme' },
    { icon: 'üé®', label: 'Theme: Noir', action: 'noir', type: 'theme' },
    { icon: 'üé®', label: 'Theme: Retro', action: 'retro', type: 'theme' },
    { icon: 'üé®', label: 'Theme: OG', action: 'og', type: 'theme' },
  ];

  const overlay = document.getElementById('cmd-palette-overlay');
  const input = document.getElementById('cmd-input');
  const list = document.getElementById('cmd-list');
  const genWrap = document.getElementById('cmd-generate');
  const genInput = document.getElementById('cmd-gen-input');
  const genGo = document.getElementById('cmd-gen-go');
  const genReset = document.getElementById('cmd-gen-reset');
  const genPills = document.getElementById('cmd-gen-pills');
  const genStatus = document.getElementById('cmd-gen-status');

  let active = 0, filtered = [...commands], genMode = false;

  function fuzzy(text, query) {
    let qi = 0;
    const tl = text.toLowerCase(), ql = query.toLowerCase();
    for (let i = 0; i < tl.length && qi < ql.length; i++) {
      if (tl[i] === ql[qi]) qi++;
    }
    return qi === ql.length;
  }

  function render() {
    list.innerHTML = '';
    filtered.forEach((cmd, i) => {
      const el = document.createElement('div');
      el.className = 'cmd-item' + (i === active ? ' active' : '');
      el.setAttribute('role', 'option');
      el.innerHTML = `<span class="cmd-item-icon">${cmd.icon}</span><span class="cmd-item-label">${cmd.label}</span>${cmd.hint ? `<span class="cmd-item-hint">${cmd.hint}</span>` : ''}`;
      el.addEventListener('click', () => execute(cmd));
      el.addEventListener('mouseenter', () => { active = i; render(); });
      list.appendChild(el);
    });
  }

  function execute(cmd) {
    if (cmd.type === 'generate') {
      enterGenMode();
      return;
    }
    close();
    if (cmd.type === 'theme') {
      if (cmd.action === 'default') {
        document.documentElement.removeAttribute('data-theme');
        localStorage.removeItem('jd-theme');
      } else {
        document.documentElement.setAttribute('data-theme', cmd.action);
        localStorage.setItem('jd-theme', cmd.action);
      }
    } else if (cmd.type === 'ext') {
      window.open(cmd.action, '_blank');
    } else {
      window.location.href = cmd.action;
    }
  }

  function open() {
    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden', 'false');
    input.value = '';
    active = 0;
    filtered = [...commands];
    render();
    requestAnimationFrame(() => input.focus());
  }

  function close() {
    if (genMode) exitGenMode();
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden', 'true');
  }

  // --- Theme Generator ---
  const K = {
    ocean:    { colors: ['#0a1628','#0e1f3a','#132a4d','#d0e8ff','#88b4d8','#4a7a9e','#38bdf8','#7dd3fc','rgba(56,189,248,0.08)'] },
    sunset:   { colors: ['#1a0a14','#2a0e1e','#3d1428','#ffe0d0','#d4a088','#9e6a5a','#f97316','#fb923c','rgba(249,115,22,0.08)'] },
    forest:   { colors: ['#0a1a0e','#0e2414','#14301c','#d0f0d8','#88c498','#4a8a5e','#22c55e','#4ade80','rgba(34,197,94,0.08)'] },
    fire:     { colors: ['#1a0800','#2a0e00','#3d1400','#ffe0cc','#d49878','#9e5a3a','#ef4444','#f87171','rgba(239,68,68,0.08)'] },
    ice:      { colors: ['#0a1420','#0e1c30','#142840','#e8f4ff','#a8c8e0','#6898b8','#67e8f9','#a5f3fc','rgba(103,232,249,0.08)'] },
    space:    { colors: ['#08001a','#0e0028','#180040','#e0d0ff','#a090cc','#685898','#a78bfa','#c4b5fd','rgba(167,139,250,0.08)'] },
    gold:     { colors: ['#1a1400','#2a2000','#3d2e00','#fff0cc','#d4b878','#9e8040','#f59e0b','#fbbf24','rgba(245,158,11,0.08)'] },
    neon:     { colors: ['#0a000e','#140018','#200028','#f0e0ff','#d0a0e0','#a060c0','#e879f9','#f0abfc','rgba(232,121,249,0.08)'] },
    earth:    { colors: ['#161210','#201a16','#2a221e','#e8ddd4','#b8a898','#887868','#a8856a','#c49e80','rgba(168,133,106,0.08)'] },
    candy:    { colors: ['#1a0e1a','#24142a','#301c3d','#ffe0f0','#e0a0c0','#b06888','#f472b6','#f9a8d4','rgba(244,114,182,0.08)'] },
    cherry:   { colors: ['#1a0008','#2a000e','#3d0018','#ffd0d8','#d48898','#9e4a5e','#e11d48','#fb7185','rgba(225,29,72,0.08)'] },
    lavender: { colors: ['#14101a','#1e1828','#282038','#e8e0f0','#b8a8d0','#8878a8','#a78bfa','#c4b5fd','rgba(167,139,250,0.08)'] },
    mint:     { colors: ['#0a1a18','#0e2422','#14302e','#d0f0e8','#88c4b8','#4a8a7e','#34d399','#6ee7b7','rgba(52,211,153,0.08)'] },
    rose:     { colors: ['#1a0a10','#2a0e1a','#3d1428','#ffe0e8','#d4a0b0','#9e6878','#fb7185','#fda4af','rgba(251,113,133,0.08)'] },
    cyber:    { colors: ['#0a0014','#0e0020','#16002e','#f0e8ff','#b8a0d4','#805898','#06b6d4','#22d3ee','rgba(6,182,212,0.08)'] },
    cyberpunk:{ colors: ['#0a0014','#0e0020','#16002e','#f0e8ff','#b8a0d4','#805898','#ff00ff','#ff66ff','rgba(255,0,255,0.08)'] },
    midnight: { colors: ['#06060e','#0a0a18','#101024','#c8c8e0','#8888aa','#505078','#6366f1','#818cf8','rgba(99,102,241,0.08)'] },
    blood:    { colors: ['#140000','#200000','#2e0000','#ffc0c0','#c07070','#803030','#dc2626','#ef4444','rgba(220,38,38,0.08)'] },
    sand:     { colors: ['#1a1610','#24201a','#2e2a22','#f0e8d8','#c8b898','#988868','#d4a458','#e0b878','rgba(212,164,88,0.08)'] },
    coral:    { colors: ['#1a0a08','#2a100e','#3d1814','#ffe0d8','#d4a098','#9e6858','#f97171','#fca5a5','rgba(249,113,113,0.08)'] },
    grape:    { colors: ['#140818','#200e28','#2e1440','#e8d0f8','#b898d4','#805098','#a855f7','#c084fc','rgba(168,85,247,0.08)'] },
    dark:     { bgMod: 'dark' },
    light:    { bgMod: 'light' },
    minimal:  { radius: '8px', fontBody: "'Inter', system-ui, sans-serif", fontDisplay: "'Georgia', serif" },
    loud:     { saturate: 1.4 },
    calm:     { saturate: 0.6 },
    warm:     { hueShift: 15 },
    cool:     { hueShift: -15 },
    retro:    { colors: ['#1a1408','#24200e','#302c16','#f0e0c0','#c0a878','#887848','#d97706','#f59e0b','rgba(217,119,6,0.08)'], fontDisplay: "'Georgia', serif" },
    vintage:  { colors: ['#181410','#22201a','#2c2a24','#e8e0d0','#b8a888','#887860','#b8860b','#d4a01a','rgba(184,134,11,0.08)'], fontDisplay: "'Georgia', serif" },
    pastel:   { saturate: 0.5 },
    rounded:  { radius: '20px' },
    sharp:    { radius: '0px' },
    glass:    { radius: '16px' },
    brutalist:{ radius: '0px', fontDisplay: "'Inter', 'Arial Black', sans-serif" },
    mono:     { fontBody: "'JetBrains Mono', monospace", fontDisplay: "'JetBrains Mono', monospace" },
    serif:    { fontDisplay: "'Georgia', 'Times New Roman', serif" },
    modern:   { fontBody: "'Inter', system-ui, sans-serif", fontDisplay: "'Inter', system-ui, sans-serif" },
    city:     { colors: ['#0a0a14','#10101e','#18182a','#d8d8e8','#9898b8','#585880','#f59e0b','#fbbf24','rgba(245,158,11,0.08)'] },
    dawn:     { colors: ['#1a0e14','#2a1420','#3d1c2e','#ffe8e0','#d4b0a0','#9e7868','#f472b6','#f9a8d4','rgba(244,114,182,0.08)'] },
    night:    { colors: ['#04040c','#08081a','#0e0e28','#c0c0d8','#7878a0','#404068','#818cf8','#a5b4fc','rgba(129,140,248,0.08)'] },
    storm:    { colors: ['#0a0c10','#10141a','#181e28','#c8d0d8','#8898a8','#486078','#64748b','#94a3b8','rgba(100,116,139,0.08)'] },
    spring:   { colors: ['#0e1a0e','#142414','#1c301c','#e0f8e0','#a0d4a0','#60a060','#4ade80','#86efac','rgba(74,222,128,0.08)'] },
    autumn:   { colors: ['#1a1008','#24180e','#302014','#f0dcc8','#c4a080','#8e6848','#ea580c','#f97316','rgba(234,88,12,0.08)'] },
    winter:   { colors: ['#0c1018','#101822','#162030','#d8e4f0','#98b0c8','#587898','#93c5fd','#bfdbfe','rgba(147,197,253,0.08)'] },
    summer:   { colors: ['#1a140a','#241e0e','#302814','#f8f0d0','#d4c088','#a08848','#facc15','#fde047','rgba(250,204,21,0.08)'] },
    matrix:   { colors: ['#000800','#001000','#001a00','#00ff41','#00cc33','#008822','#00ff41','#33ff66','rgba(0,255,65,0.06)'], fontBody: "'JetBrains Mono', monospace", fontDisplay: "'JetBrains Mono', monospace" },
    dracula:  { colors: ['#282a36','#2e303e','#363848','#f8f8f2','#c0b8d0','#888098','#bd93f9','#d0a8ff','rgba(189,147,249,0.08)'] },
    nord:     { colors: ['#2e3440','#3b4252','#434c5e','#eceff4','#b8c0cc','#808898','#88c0d0','#a0d0e0','rgba(136,192,208,0.08)'] },
    hacker:   { colors: ['#000800','#001000','#001a00','#00ff41','#00cc33','#008822','#00ff41','#33ff66','rgba(0,255,65,0.06)'], fontBody: "'JetBrains Mono', monospace" },
    vaporwave:{ colors: ['#180828','#200e38','#2a1448','#f0d0ff','#c088e0','#8048b0','#ff71ce','#ff9de2','rgba(255,113,206,0.08)'] },
    synthwave:{ colors: ['#120020','#1a0030','#240044','#ffe0ff','#d0a0e0','#9060b8','#ff00ff','#ff66ff','rgba(255,0,255,0.08)'] },
  };

  function hexToRgb(h) { return [parseInt(h.slice(1,3),16), parseInt(h.slice(3,5),16), parseInt(h.slice(5,7),16)]; }
  function rgbToHex(r,g,b) { return '#'+[r,g,b].map(v=>Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join(''); }

  function blendColors(sets) {
    if (!sets.length) return null;
    if (sets.length === 1) return sets[0];
    return sets[0].map((_, i) => {
      if (sets[0][i].startsWith('rgba')) return sets[0][i];
      const rgbs = sets.map(a => hexToRgb(a[i]));
      const avg = [0,1,2].map(ch => rgbs.reduce((s,v) => s+v[ch], 0) / rgbs.length);
      return rgbToHex(avg[0], avg[1], avg[2]);
    });
  }

  function generateTheme(prompt) {
    const words = prompt.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/);
    const matched = [], colorSets = [];
    let radius = null, fontBody = null, fontDisplay = null;
    for (const w of words) {
      if (K[w]) {
        matched.push(w);
        const k = K[w];
        if (k.colors) colorSets.push(k.colors);
        if (k.radius) radius = k.radius;
        if (k.fontBody) fontBody = k.fontBody;
        if (k.fontDisplay) fontDisplay = k.fontDisplay;
      }
    }
    if (!matched.length) return null;
    const colors = blendColors(colorSets) || K.space.colors;
    const vars = {
      '--bg': colors[0], '--bg-2': colors[1], '--bg-3': colors[2],
      '--text': colors[3], '--text-2': colors[4], '--text-3': colors[5],
      '--accent': colors[6], '--accent-2': colors[7], '--accent-bg': colors[8],
    };
    if (radius) vars['--radius'] = radius;
    if (fontBody) vars['--font-body'] = fontBody;
    if (fontDisplay) vars['--font-display'] = fontDisplay;
    return { vars, matched };
  }

  function applyGenTheme(result) {
    const root = document.documentElement;
    if (!root.dataset.genOrigTheme) root.dataset.genOrigTheme = root.getAttribute('data-theme') || '';
    root.setAttribute('data-theme', 'generated');
    for (const [k,v] of Object.entries(result.vars)) root.style.setProperty(k, v);
    const shim = document.createElement('div');
    shim.className = 'theme-shimmer';
    document.body.appendChild(shim);
    setTimeout(() => shim.remove(), 500);
  }

  function resetGenTheme() {
    const root = document.documentElement;
    const orig = root.dataset.genOrigTheme || '';
    ['--bg','--bg-2','--bg-3','--text','--text-2','--text-3','--accent','--accent-2','--accent-bg','--radius','--font-body','--font-display'].forEach(v => root.style.removeProperty(v));
    if (orig) root.setAttribute('data-theme', orig); else root.removeAttribute('data-theme');
    delete root.dataset.genOrigTheme;
    genPills.innerHTML = '';
    genStatus.textContent = '';
    genInput.value = '';
  }

  function enterGenMode() {
    genMode = true;
    list.style.display = 'none';
    genWrap.classList.add('active');
    input.style.display = 'none';
    document.querySelector('.cmd-search-icon').style.display = 'none';
    document.querySelector('.cmd-divider').style.display = 'none';
    requestAnimationFrame(() => genInput.focus());
  }

  function exitGenMode() {
    genMode = false;
    list.style.display = '';
    genWrap.classList.remove('active');
    input.style.display = '';
    document.querySelector('.cmd-search-icon').style.display = '';
    document.querySelector('.cmd-divider').style.display = '';
  }

  function doGenerate() {
    const p = genInput.value.trim();
    if (!p) return;
    const result = generateTheme(p);
    genPills.innerHTML = '';
    if (!result) {
      genStatus.textContent = 'No keywords matched ‚Äî try: ocean, sunset, forest, neon, dark, minimal, mono‚Ä¶';
      return;
    }
    result.matched.forEach(w => {
      const pill = document.createElement('span');
      pill.className = 'cmd-gen-pill';
      pill.textContent = w;
      genPills.appendChild(pill);
    });
    genStatus.textContent = '\u2728 Applied "' + p + '" \u2014 ' + result.matched.length + ' keyword' + (result.matched.length > 1 ? 's' : '') + ' blended';
    applyGenTheme(result);
  }

  genGo.addEventListener('click', doGenerate);
  genInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); doGenerate(); }
    if (e.key === 'Escape') { e.preventDefault(); close(); }
  });
  genReset.addEventListener('click', resetGenTheme);

  // --- Events ---
  input.addEventListener('input', () => {
    const q = input.value.trim();
    filtered = q ? commands.filter(c => fuzzy(c.label, q)) : [...commands];
    active = 0;
    render();
  });

  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      overlay.classList.contains('open') ? close() : open();
    }
    if (!overlay.classList.contains('open') || genMode) return;
    if (e.key === 'Escape') { e.preventDefault(); close(); }
    if (e.key === 'ArrowDown') { e.preventDefault(); active = (active + 1) % filtered.length; render(); list.children[active]?.scrollIntoView({ block: 'nearest' }); }
    if (e.key === 'ArrowUp') { e.preventDefault(); active = (active - 1 + filtered.length) % filtered.length; render(); list.children[active]?.scrollIntoView({ block: 'nearest' }); }
    if (e.key === 'Enter' && filtered[active]) { e.preventDefault(); execute(filtered[active]); }
  });

  overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
})();
</script>
